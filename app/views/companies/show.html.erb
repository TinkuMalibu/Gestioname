<%= render @company %>
<script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css">
<!-- Button trigger modal -->
<button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#exampleModal1">
  New Expense
</button>

<!-- Modal -->
<div class="modal fade" id="exampleModal1" tabindex="-1" aria-labelledby="exampleModalLabel1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h1 class="modal-title fs-5" id="exampleModalLabel1">New Expense</h1>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <%= render "expenses/new_modal_expense" %>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <button type="button" class="btn btn-primary">Save changes</button>
      </div>
    </div>
  </div>
</div>

<!-- Button trigger modal -->
<button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#exampleModal2">
  New Income
</button>
<div class="modal fade" id="exampleModal2" tabindex="-1" aria-labelledby="exampleModalLabel2" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h1 class="modal-title fs-5" id="exampleModalLabel2">New Income</h1>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <%= render "incomes/new_modal_income" %>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <button type="button" class="btn btn-primary">Save changes</button>
      </div>
    </div>
  </div>
</div>

<div class="container">
  <div class="class row">
    <div class="col-4 mb-3">
      <div class="card-category">
        <div class="row">
          <div class="icono-chico mb-3">
            <i class="fa-solid fa-money-bill"></i>
          </div>
          <div class="col">
            <h5 class="text-body-tertiary">Total Balance</h5>
            <% if @total_amount < 0 %>
              <h3 class="text-danger fw-bold">$<%= number_with_delimiter(@total_amount.to_i, delimiter: '.', separator: ',')  %></h3>
            <% else %>
              <h3 class="text-success fw-bold">$<%= number_with_delimiter(@total_amount.to_i, delimiter: '.', separator: ',')  %></h3>
            <% end %>
          </div>
          <div class="col-5 d-flex align-items-center justify-content-center">
            <h2>
            </h2>
          </div>
        </div>
      </div>
    </div>
    <div class="col-4 mb-3">
      <div class="card-category">
        <div class="row">
            <div class="icono-chico mb-3">
            <i class="fa-solid fa-chart-simple"></i>
        </div>
          <div class="col">
            <h5 class="text-body-tertiary">Total Expense</h5>
            <h3 class="text-black fw-bold">$<%= number_with_delimiter(@expense_amount.to_i, delimiter: '.', separator: ',')  %></h3>
            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#exampleModal6">
              Expenses
            </button>
            <div class="modal fade" id="exampleModal6" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
              <div class="modal-dialog">
                <div class="modal-content">
                  <div class="modal-header">
                    <h1 class="modal-title fs-5" id="exampleModalLabel">Expenses</h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                  </div>
                  <div class="modal-body">
                    <div class="data-table">
                      <table class="table table-striped table-bordered">
                        <thead class="thead-dark">
                          <tr>
                            <th scope="col" class="filterable">Item Name</th>
                            <th scope="col">Amount</th>
                            <th scope="col">Date</th>
                            <th scope="col">Details</th>
                          </tr>
                        </thead>
                        <tbody>
                          <% @expenses.sort_by(&:date).reverse.each do |register| %>
                            <tr>
                              <td class="filterable" data-search="<%= register.item_name %>"><%= register.item_name %></td>
                              <td>$ <%= register.amount %></td>
                              <td><%= register.date %></td>
                             <td>
                              <button class="btn btn-secondary" data-bs-toggle="popover" title="Popover title" data-bs-content="" >
                                <%= link_to '', expense_path(register), class: 'fa fa-info-circle' %>
                              </button>
                            </td>
                            </tr>
                          <% end %>
                        </tbody>
                      </table>
                    </div>
                  </div>
                  <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary">Save changes</button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="col-4 mb-3">
      <div class="card-category">
        <div class="row">
            <div class="icono-chico mb-3">
              <i class="fa-solid fa-chart-line"></i>
            </div>
          <div class="col">
            <h5 class="text-body-tertiary">Total Income</h5>
            <h3 class="text-black fw-bold">$<%= number_with_delimiter(@incomes_amount.to_i, delimiter: '.', separator: ',')  %></h3>
              <!-- Button trigger modal -->
              <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#exampleModal">
                Incomes
              </button>
              <!-- Modal -->
              <div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
                <div class="modal-dialog">
                  <div class="modal-content">
                    <div class="modal-header">
                      <h1 class="modal-title fs-5" id="exampleModalLabel">Incomes</h1>
                      <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                      <div>
                        <table class="table table-striped table-bordered">
                          <thead class="thead-dark">
                            <tr>
                              <th scope="col" class="filterable">Item Name</th>
                              <th scope="col">Amount</th>
                              <th scope="col">Date</th>
                              <th scope="col">Details</th>
                            </tr>
                          </thead>
                          <tbody>
                            <% @incomes.sort_by(&:date).reverse.each do |register| %>
                              <tr>
                                <td class="filterable" data-search="<%= register.item_name %>"><%= register.item_name %></td>
                                <td>$ <%= register.amount %></td>
                                <td><%= register.date %></td>
                                <td><%= link_to '', expense_path(register), class: 'fa fa-info-circle' %></td>
                              </tr>
                            <% end %>
                          </tbody>
                        </table>
                      </div>
                    </div>
                    <div class="modal-footer">
                      <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                      <button type="button" class="btn btn-primary">Save changes</button>
                    </div>
                  </div>
                </div>
              </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <% total_amount = 0 %>
  <% incomes_amount = 0 %>
  <% expense_amount = 0 %>
  <%# EN ESTE DIV DEBERIA IR GRAFICOS QUE IRÁ CAMBIANDO ??%>
  <% if current_user.subscription%>
  <h2 class="fw-bold mt-3">Graphs</h2>
  <ul class="nav nav-tabs" id="myTab" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link active" id="home-tab" data-bs-toggle="tab" data-bs-target="#home-tab-pane" type="button" role="tab" aria-controls="home-tab-pane" aria-selected="true">Column chart</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="profile-tab" data-bs-toggle="tab" data-bs-target="#profile-tab-pane" type="button" role="tab" aria-controls="profile-tab-pane" aria-selected="false">Line chart</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="contact-tab" data-bs-toggle="tab" data-bs-target="#contact-tab-pane" type="button" role="tab" aria-controls="contact-tab-pane" aria-selected="false">Pie chart</button>
    </li>
  </ul>

  <div class="tab-content" id="myTabContent">
    <div class="tab-pane fade show active" id="home-tab-pane" role="tabpanel" aria-labelledby="home-tab" tabindex="0">
      <div class="card-contenido">
        <%= column_chart Expense.joins(:company).where(company_id: params[:id]).group(:item_name).sum("amount") %>
      </div>
    </div>
    <div class="tab-pane fade" id="profile-tab-pane" role="tabpanel" aria-labelledby="profile-tab" tabindex="0">
      <div class="card-contenido">
        <%= area_chart Expense.joins(:company).where(company_id: params[:id]).group(:item_name).sum("amount") %>
      </div>
    </div>
    <div class="tab-pane fade" id="contact-tab-pane" role="tabpanel" aria-labelledby="contact-tab" tabindex="0">
      <div class="card-contenido">
          <%= pie_chart Expense.joins(:company).where(company_id: params[:id]).group(:item_name).sum("amount"), donut: true %>
      </div>
    </div>
  </div>
<% end  %>

  <%# EN ESTE DIV DEBERIA IR TODO EL CONTENIDO QUE IRÁ CAMBIANDO ??%>
  <%# link_to 'Importar Excel', import_company_path(@company), class: 'btn btn-primary' %>

  <h2 class="fw-bold mt-3">Recent</h2>
  <div class="data-table">
    <table class="table table-striped table-bordered" id="example">
      <thead class="thead-dark">
        <tr>
          <th scope="col" class="filterable">Item Name</th>
          <th scope="col">Amount</th>
          <th scope="col">Date</th>
          <th scope="col">Details</th>
        </tr>
      </thead>
      <tbody>
        <% @registers.sort_by(&:date).reverse.each do |register| %>
          <tr>
            <td class="filterable" data-search="<%= register.item_name %>"><%= register.item_name %></td>
            <td>$ <%= register.amount %></td>
            <td><%= register.date %></td>
            <td><%= link_to '', expense_path(register), class: 'fa fa-info-circle' %></td>
          </tr>
        <% end %>
      </tbody>
    </table>
  </div>
</div>
<%= render "companies/import_form" %>


<script src="https://cdn.jsdelivr.net/npm/apexcharts@latest"></script>
<script>
  $(document).ready(function() {
  // Verificar si el elemento ya existe antes de agregarlo
  if ($('#example_wrapper').length === 0) {
    var table = $('#example').DataTable({
      buttons: ['copy', 'excel', 'pdf', 'print'],
      "order": [[0, "asc"]],
      "columnDefs": [
        {
          "targets": 'filterable',
          "searchable": true,
          "orderable": true
        }
      ],
      "pagingType": "full_numbers",
      "pageLength": 5,
      "lengthMenu": [5, 10, 25, 50]
    });
    var buttonsContainer = $('#example_wrapper .col-md-6:eq(0)');
    if (buttonsContainer.find('.buttons-copy').length === 0) {
      table.buttons().container().appendTo(buttonsContainer);
    }
    $('#example_wrapper .buttons-copy').on('click', function() {
      var filteredData = table.rows({ filter: 'applied' }).data().toArray();
      // Realizar acciones con los datos filtrados, como registrarlos
      toastr.success('Copy Successful!', 'Copy Message');
    });
    $('#example_wrapper .buttons-excel').on('click', function() {
      var filteredData = table.rows({ filter: 'applied' }).data().toArray();
      // Realizar acciones con los datos filtrados, como exportar a Excel o registrarlos
      toastr.success('Excel Download Successful!', 'Excel Message');
    });
    $('#example_wrapper .buttons-pdf').on('click', function() {
      var filteredData = table.rows({ filter: 'applied' }).data().toArray();
      // Realizar acciones con los datos filtrados, como exportar a PDF o registrarlos
      toastr.success('PDF Download Successful!', 'PDF Message');
    });
    $("#searchBtn").on("click", function() {
      table.draw();
    });
  }
});

$(document).ready(function() {
    $('[data-bs-toggle="popover"]').popover();
  });
</script>


<div class="mt-3">
  <%= link_to "Back to companies", companies_path, class:"btn btn-primary" %>
</div>
